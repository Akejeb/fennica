---
title: "Historical Methods 1640-1828"
author: "Marjanen, Lahti, Roivainen, Tolonen"
date: "August 31, 2018"
output: word_document
---


This supplementary document provides details of the data fields
analyzed in the main text.



```{r init, echo=FALSE, message=FALSE, warning=FALSE}
# To be run after all historical methods analyses
library(skimr)
library(ggplot2)
theme_set(theme_bw(15))
library(tidyverse)
df0 <- df0 %>% mutate(Subject = subject_topic) %>%
               filter(publication_year >=1640) %>%
               filter(publication_year <=1828) 	       


d <- list()

fen <- subset(df0, catalog == "Fennica")
kun <- subset(df0, catalog == "Kungliga")
cats <- list(Fennica = fen, Kungliga = kun)

selected.fields <- c("publication_year", "publication_place", "gatherings", "title", "pagecount", "publisher", "language", "Subject")

for (cat in unique(df0$catalog)) {

  dd <- subset(df0, catalog == cat)[, selected.fields]

  complete <- round(100 * colMeans(!is.na(dd)), 1)
  unique <- apply(dd, 2, function (x) {length(unique(x))})

  d[[cat]] <- data.frame(Field = colnames(dd), Complete = complete, Unique = unique)

}
```


Records in the final data set used in the analyses:

 * Fennica: ```r nrow(subset(df0, catalog == "Fennica"))```
 * Kungliga: ```r nrow(subset(df0, catalog == "Kungliga"))```



Data availability for the key fields analyzed in this work (%):

```{r complete, echo=FALSE, message=FALSE, warning=FALSE}
w <- data.frame(Field = map_fieldnames(colnames(dd)),
                Fennica = d$Fennica$Complete,
	        Kungliga = d$Kungliga$Complete) %>%
	     arrange(desc(Fennica))

kable(w)
```




The following table indicates the MARC fields for each data type. The
language information was picked from the MARC fields 008lang and 041a
for Kungliga and Fennica, respectively.


```{r fieldtable, echo=FALSE, message=FALSE, warning=FALSE}
f <- field_table()

fennica_fields <- c(
"041a",
"041h", 
"100a",
"100d",
"240a",
"245a",
"245b",
"260a",
"260b",
"260c",
"300a",
"300b",
"300c",
"300e",
"310a",
"362a",
"500a",
"502a",
"502c",
"502d",
"510a",
"510c",
"650a",
"651a",
"710a",
"720a",
"785t",
"852a")

kungliga_fields <- c(
setdiff(fennica_fields, c("041a", "041h")),
"008lang",
"100a",
"100d",
"110a",
"240a",
"245a",
"245b",
"245c",
"260a",
"260b",
"260c",
"260e",
"260f",
"300a",
"300b",
"300c",
"300e",
"310a",
"362a",
"440a",
"440v",
"500a",
"502a",
"502c",
"502d",
"510a",
"510c",
"650a",
"650x",
"650y",
"650z",
"651a",
"700a",
"700d",
"710a",
"720a",
"740a",
"772c",
"772d",
"772t",
"785t",
"852a",
"852j",
"852z",
"866x",
"900a",
"900d",
"900u",
"976a",
"976b")

all_fields <- union(fennica_fields, kungliga_fields)

df <- data.frame(MARC = all_fields)
df$Description <- f[match(df$MARC, f$field), "concept"]
df$Kungliga  <- c("", "x")[1 + df$MARC %in% kungliga_fields]
df$Fennica  <- c("", "x")[1 + df$MARC %in% fennica_fields]
df <- df %>% arrange(MARC)

kable(df)
```




### Author

Number of unique authors and all documents with author information:

```{r author, echo=FALSE, message=FALSE, warning=FALSE}
field <- "author"
df <- df0
df$field <- df[[field]]
df <- df %>% group_by(catalog) %>%
              summarise(Unique = length(unique(field)),
	                All = sum(!is.na(field)))
colnames(df) <- gsub("catalog", "Catalogue", colnames(df))
kable(df, digits = 1)
```


The most common authors in Fennica:

```{r authors_fen, echo=FALSE, message=FALSE, warning=FALSE}
tab <- top(fen, field, 10, "data.frame", round = 1)
colnames(tab) <- gsub("author", "Author", colnames(tab))
kable(tab)
```


The most common authors in Kungliga:

```{r authors_kun, echo=FALSE, message=FALSE, warning=FALSE}
tab <- top(kun, field, 10, "data.frame", round = 1)
colnames(tab) <- gsub("author", "Author", colnames(tab))
kable(tab)
```


### Format (Gatherings)

Proportion (%) of unique gatherings and all documents with gatherings information:

```{r gatherings, echo=FALSE, message=FALSE, warning=FALSE}
field <- "gatherings"
df <- df0
df$field <- df[[field]]
df <- df %>% group_by(catalog, gatherings) %>%
              summarise(n = n())
df <- spread(df, catalog, n, fill = 0)
colnames(df) <- c("Gatherings", "Fennica", "Kungliga")
df$Gatherings <- as.character(df$Gatherings)
df$Gatherings <- gsub("NA", "Missing", df$Gatherings)

df2 <- df
df2$Fennica <- round(100 * df2$Fennica / nrow(fen), 1)
df2$Kungliga <- round(100 * df2$Kungliga / nrow(kun), 1)

kable(df2)
```






### Publisher

Number of unique publishers and all documents with publisher information:

```{r publisher, echo=FALSE, message=FALSE, warning=FALSE}
field <- "publisher"
df <- df0
df$field <- df[[field]]
df <- df %>% group_by(catalog) %>%
              summarise(Unique = length(unique(field)),
	                All = sum(!is.na(field)))
colnames(df) <- gsub("catalog", "Catalogue", colnames(df))
kable(df, digits = 1)
```


The most common publishers in Fennica:

```{r publishers_fen, echo=FALSE, message=FALSE, warning=FALSE}
tab <- top(fen, field, 10, "data.frame", round = 1)
colnames(tab) <- gsub("publisher", "Publisher", colnames(tab))
kable(tab)
```


The most common publishers in Kungliga:

```{r publishers_kun, echo=FALSE, message=FALSE, warning=FALSE}
tab <- top(kun, field, 10, "data.frame", round = 1)
colnames(tab) <- gsub("publisher", "Publisher", colnames(tab))
kable(tab)
```


### Pages

Page count variation per gatherings. The variants have been combined (2long/2to; 4long/4to; 8long/8vo; 12long/12mo). Documents with missing gatherings are not shown.

```{r pagecount, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, figh.height=1}
df <- df0
df$gatherings <- gsub("^2long", "2fo", df$gatherings)
df$gatherings <- gsub("4long", "4to", df$gatherings)
df$gatherings <- gsub("8long", "8vo", df$gatherings)
df$gatherings <- gsub("12long", "12mo", df$gatherings)
df <- df[which(!df$gatherings == "NA"), ]
df <- subset(df, !is.na(pagecount))
df$gatherings <- order_gatherings(df$gatherings)

cols <- default_colors("gatherings", levels(df$gatherings))

p <- ggplot(df) +
       geom_histogram(aes(x = pagecount,
		    group = gatherings,       
                    #y = ..count../sum(..count..),
                    fill = gatherings),
                    color = "black",
		    alpha = 0.5
		    ) + 
       labs(x = "Page count (n)",
            y = "Frequency (n)") +
       scale_x_log10(breaks = c(1, 10, 100, 1000)) +
       scale_y_log10(breaks = c(1, 10, 100, 1000)) +
       scale_fill_manual(values = unname(cols)) +       
       facet_grid(catalog ~ gatherings) +
       guides(fill = "none") + 
       labs(y = "Frequency (n)") +
       theme(
         axis.text = element_text(size=10)
             )
print(p)
```


### Paper consumption

Paper consumption estimates per gatherings (sheets per document). The variants have been combined (2long/2to; 4long/4to; 8long/8vo; 12long/12mo). Documents with missing page count estimates are not shown.

```{r paper, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, figh.height=1}
x <- c(.01, .1, 1, 10, 100, 1000)
df <- df0
df$gatherings <- gsub("^2long", "2fo", df$gatherings)
df$gatherings <- gsub("4long", "4to", df$gatherings)
df$gatherings <- gsub("8long", "8vo", df$gatherings)
df$gatherings <- gsub("12long", "12mo", df$gatherings)
df <- df[which(!df$gatherings == "NA"), ]
df <- subset(df, !is.na(paper))
df$gatherings <- order_gatherings(df$gatherings)
cols <- default_colors("gatherings", levels(df$gatherings))

p <- ggplot(df) +
       geom_histogram(aes(x = paper/1e3, # Remove print run estimates
		    group = gatherings,       
                    fill = gatherings),
                    color = "black",
		    alpha = 0.5
		    ) +
       scale_fill_manual(values = unname(cols)) + 		    
       labs(x = "Paper per document (sheets)",
            y = "Frequency (n)") +
       scale_y_log10(breaks = c(1, 10, 100, 1000)) +
       scale_x_log10(breaks = x,
           labels=scales::trans_format('log10', scales::math_format(10^.x))) + 
       facet_grid(catalog ~ gatherings) +
       guides(fill = "none") + 
       labs(y = "Frequency (n)") +
       theme(
         axis.text = element_text(size=10)
             ) 

print(p)

```




### Publication year

```{r year, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, figh.height=3}
p <- ggplot(df0) +
       geom_histogram(aes(x = publication_year)) + 
       labs(x = "Publication year",
            y = "Frequency (n)") +
       # scale_x_log10(breaks = c(1, 10, 100, 1000)) +       
       facet_grid(. ~ catalog)
print(p)
```


### Language

Number of unique languages and all documents with language information.

```{r languages , echo=FALSE, message=FALSE, warning=FALSE}
field <- "language"
df <- df0
df$field <- df[[field]]
df <- df %>% group_by(catalog) %>%
              summarise(Unique = length(unique(field)),
	                All = sum(!is.na(field)))
colnames(df) <- gsub("catalog", "Catalogue", colnames(df))
colnames(df) <- gsub("language", "Language", colnames(df))
kable(df)
```


The most common languages in Fennica:

```{r languages_fen, echo=FALSE, message=FALSE, warning=FALSE}
tab <- top(fen, field, 10, "data.frame", round = 1)
colnames(tab) <- gsub("language", "Language", colnames(tab))
kable(tab)
```

The most common languages in Kungliga:

```{r languages_kun, echo=FALSE, message=FALSE, warning=FALSE}
tab <- top(kun, field, 10, "data.frame", round = 1)
colnames(tab) <- gsub("language", "Language", colnames(tab))
kable(tab)
```


### Publication place

Number of unique publication places and all documents with publication place information.

```{r places, echo=FALSE, message=FALSE, warning=FALSE}
field <- "publication_place"
df <- df0
df$field <- df[[field]]

df <- df %>% group_by(catalog) %>%
              summarise(Unique = length(unique(field)),
	                All = sum(!is.na(field)))
colnames(df) <- gsub("catalog", "Catalogue", colnames(df))
kable(df)
```


The most common publication places in Fennica:

```{r places_fen, echo=FALSE, message=FALSE, warning=FALSE}
tab <- top(fen, field, 10, "data.frame", round = 1)
colnames(tab) <- gsub("publication_place", "Publication place", colnames(tab))
kable(tab)
```

The most common publication places in Kungliga:

```{r places_kun, echo=FALSE, message=FALSE, warning=FALSE}
tab <- top(kun, field, 10, "data.frame", round = 1)
colnames(tab) <- gsub("publication_place", "Publication place", colnames(tab))
kable(tab)
```


### Subject

Number of unique and all subject topics per catalogue.

```{r genre, echo=FALSE, message=FALSE, warning=FALSE}
df <- df0 %>% group_by(catalog) %>%
              summarise(Unique = length(unique(Subject)),
	                All = sum(!is.na(Subject)))
colnames(df) <- gsub("catalog", "Catalogue", colnames(df))
kable(df)
```


The most common subject topics in Fennica:

```{r genres_fen, echo=FALSE, message=FALSE, warning=FALSE}
kable(top(fen, "Subject", 10, "data.frame", round = 1))
```


The most common subject topics in Kungliga:

```{r genres_kun, echo=FALSE, message=FALSE, warning=FALSE}
kable(top(kun, "Subject", 10, "data.frame", round = 1))
```



### Title


Number of unique and all titles per catalogue.

```{r titles, echo=FALSE, message=FALSE, warning=FALSE}
df <- df0 %>% group_by(catalog) %>%
              summarise(Unique = length(unique(title)),
	                All = sum(!is.na(title)))
colnames(df) <- gsub("catalog", "Catalogue", colnames(df))
kable(df)
```


Title length variation quantified in characters and in words.

```{r title_characters, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, figh.height=4}
theme_set(theme_bw(20))
df <- df0 %>% mutate(title_chars = nchar(title))
p <- ggplot(df) +
       geom_histogram(aes(x = title_chars)) + 
       labs(x = "Title length (characters)",
            y = "Frequency (n)") +
       #scale_x_log10(breaks = 10^(0:3)) +
       scale_x_log10(breaks = c(1, 10, 100, 1000)) +       
       facet_grid(. ~ catalog)
print(p)
```




```{r title_words, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, figh.height=4}
theme_set(theme_bw(15))
library(ggplot2)
library(stringi)
theme_set(theme_bw(20))
library(tidyverse)
df <- df0 %>% mutate(title_words = stri_count_words(title))
p <- ggplot(df) +
       geom_histogram(aes(x = title_words)) + 
       labs(x = "Title length (words)",
            y = "Frequency (n)") +
       #scale_x_log10(breaks = 10^(0:3)) +
       scale_x_log10(breaks = c(1, 10, 100)) +       
       facet_grid(. ~ catalog)
print(p)
```



